class EsportsNotifier{constructor(e){this.config=e,this.VERSION="0.0.1",this.APPNAME="esports notifier",this.GITHUB_REPOSITORY="lucasvtiradentes/esports-notifier",this.TODAY_DATE="",this.SESSION_LOGS=[],this.ENVIRONMENT=this.detectEnvironment(),this.USER_EMAIL="production"===this.ENVIRONMENT?this.getUserEmail():"",this.ERRORS={mustSpecifyConfig:"You must specify the settings when starting the class",timeToSendEmailIncorrect:"You must specify a correct time string in config.datetime.timeToSendEmail, such as: 07:00"},this.todayMatches=[],this.todayFavoriteTeamsMatches=[],this.validateConfigs(e),this.config=e,this.TODAY_DATE=this.getDateFixedByTimezone(new Date,this.config.datetime.diffHoursFromUtc).toISOString().split("T")[0],this.logger(`${this.APPNAME} is running at version ${this.VERSION} in ${this.ENVIRONMENT} environment`),this.logger(`check the docs for your version here: https://github.com/${this.GITHUB_REPOSITORY}/tree/v${this.VERSION}#readme`)}validateConfigs(e){var t;if(!e)throw new Error(this.ERRORS.mustSpecifyConfig);[{objToCheck:e,requiredKeys:["esports","datetime","settings"],name:"configs"},{objToCheck:null==e?void 0:e.esports,requiredKeys:["favoriteTeams","games"],name:"configs.esports"},{objToCheck:null===(t=null==e?void 0:e.esports)||void 0===t?void 0:t.games,requiredKeys:["csgo","valorant","rainbowSixSiege","dota","lol","rocketLeague","overwatch","callOfDuty","freeFire"],name:"configs.esports.games"},{objToCheck:null==e?void 0:e.datetime,requiredKeys:["diffHoursFromUtc","timeToSendEmail"],name:"configs.datetime"},{objToCheck:null==e?void 0:e.settings,requiredKeys:["notifyOnlyAboutTodayGames","strictTeamComparasion","maintanceMode","loopFunction"],name:"configs.settings"}].forEach((e=>{const{objToCheck:t,requiredKeys:i,name:n}=e;i.forEach((e=>{if(!t||!Object.keys(t).includes(e))throw new Error(`missing key in ${n}: ${e}`)}))}))}detectEnvironment(){return"undefined"==typeof UrlFetchApp?"development":"production"}logger(e,t){this.SESSION_LOGS.push(e),"before"===t&&console.log(""),console.log(e),"after"===t&&console.log("")}getDateFixedByTimezone(e,t){return e.setHours(e.getHours()+t),e}parseHtmlData(e){return globalThis.Cheerio.load(e)}getUserEmail(){return"production"===this.ENVIRONMENT?Session.getActiveUser().getEmail():""}getPageContent(e){return"production"===this.ENVIRONMENT?UrlFetchApp.fetch(e,{muteHttpExceptions:!0}).getContentText():""}getCsgoMatches(){const e="https://liquipedia.net",t=`${e}/counterstrike/Liquipedia:Matches`,i=this.getPageContent(t),n=this.parseHtmlData(i)("table.infobox_matches_content"),s=e=>{var t,i;const n=e.children.find((e=>{var t;return(null===(t=e.attribs)||void 0===t?void 0:t.class.search("team-template-text"))>-1}));return null===(i=null===(t=null==n?void 0:n.children[0])||void 0===t?void 0:t.children[0])||void 0===i?void 0:i.data},r=e=>{var t,i,n;const s=e.children.find((e=>{var t;return(null===(t=e.attribs)||void 0===t?void 0:t.class.search("team-template-image-icon"))>-1}));return null===(n=null===(i=null===(t=null==s?void 0:s.children[0])||void 0===t?void 0:t.children[0])||void 0===i?void 0:i.attribs)||void 0===n?void 0:n.src},a=Array.from(n).filter((e=>"1"===e.parent.attribs["data-toggle-area-content"])).map((i=>{const n=this.getDateFixedByTimezone(new Date(i.children[1].children[2].children[1].children[0].children[0].children[0].data.replace("- ","")),this.config.datetime.diffHoursFromUtc).toISOString(),a=i.children[1].children[0].children[1].children[0],o=i.children[1].children[0].children[5].children[0],l=n.split("T")[0],c=n.split("T")[1].slice(0,5),h=i.children[1].children[2].children[1].children[1].children[0].children[0].children[0].data,d=s(a),g=r(a),m=s(o),p=r(o);return{game:{name:"csgo",image:"https://seeklogo.com/images/C/counter-strike-global-offensive-logo-CFCEFBBCE2-seeklogo.com.png",link:t},teamA:{name:d,image:`${e}${g}`,countryImage:""},teamB:{name:m,image:`${e}${p}`,countryImage:""},teams:[d,m],date:l,time:c,event:h,link:""}}));return this.logger(`found ${a.length} csgo matches`),a}getR6Matches(){const e="https://siege.gg",t=`${e}/matches`,i=this.getPageContent(t),n=this.parseHtmlData(i)("a.match--awaiting-results"),s=Array.from(n).map((i=>{const n=this.getDateFixedByTimezone(new Date(i.children[0].attribs["data-time"]),this.config.datetime.diffHoursFromUtc).toISOString(),s=n.split("T")[0],r=n.split("T")[1].slice(0,5),a=i.children[0].children[2].children[0].data,o=i.attribs.href,l=i.children[1].children[0].children[0].children[2].children[0].data.trim(),c=i.children[1].children[0].children[0].children[0].attribs.src,h=i.children[1].children[0].children[0].children[1].children[0].attribs.src,d=i.children[1].children[2].children[0].children[2].children[0].data.trim(),g=i.children[1].children[2].children[0].children[0].attribs.src,m=i.children[1].children[2].children[0].children[1].children[0].attribs.src;return{game:{name:"rainbowSixSiege",image:"https://www.clipartmax.com/png/small/308-3080527_0-tom-clancys-rainbow-six-siege.png",link:t},teamA:{name:l,image:c,countryImage:h},teamB:{name:d,image:g,countryImage:m},teams:[l,d],date:s,time:r,event:a,link:`${e}${o}`}}));return this.logger(`found ${s.length} rainbowSixSiege matches`),s}getValorantMatches(){const e="https://www.vlr.gg",t=`${e}/matches`,i=this.getPageContent(t),n=this.parseHtmlData(i)("a.match-item"),s=Array.from(n).map((i=>{const n=new Date(i.parent.prev.prev.children[0].data.trim()).toISOString().split("T")[0],s=(e=>{const[t,i]=e.split(" "),n=t.split(":"),s=`${("AM"===i?Number(n[0]):Number(n[0])+12)+2}:${n[1]}`;return 4===s.length?`0${s}`:s})(i.children[0].next.children[0].data.trim()),r=i.children[13].children[2].data.trim(),a=i.children[3].children[1].children[1].children[1].children[2].data.trim(),o=i.children[3].children[1].children[1].children[1].children[1].attribs.class.replace("flag ",""),l=i.children[3].children[3].children[1].children[1].children[2].data.trim(),c=i.children[3].children[3].children[1].children[1].children[1].attribs.class.replace("flag ","");return{game:{name:"valorant",image:"https://seeklogo.com/images/V/valorant-logo-FAB2CA0E55-seeklogo.com.png",link:t},teamA:{name:a,image:"",countryImage:`${e}/img/icons/flags/16/${o.replace("mod-","")}.png`},teamB:{name:l,image:"",countryImage:`${e}/img/icons/flags/16/${c.replace("mod-","")}.png`},teams:[a,l],date:n,time:s,event:r,link:`${e}${i.attribs.href}`}}));return this.logger(`found ${s.length} valorant matches`),s}getAllTodayMatches(){const e=[];return this.config.esports.games.csgo&&e.push(...this.getCsgoMatches()),this.config.esports.games.valorant&&e.push(...this.getValorantMatches()),this.config.esports.games.rainbowSixSiege&&e.push(...this.getR6Matches()),this.config.esports.games.dota,this.config.esports.games.lol,this.config.esports.games.rocketLeague,this.config.esports.games.overwatch,this.config.esports.games.callOfDuty,this.config.esports.games.freeFire,this.todayMatches=e.sort(((e,t)=>Number(new Date(`${e.date}T${e.time}`))-Number(new Date(`${t.date}T${t.time}`)))),this.logger(`there were found ${this.todayMatches.length} matches across all selected games`,"before"),this.todayMatches}getFavoriteTeamsMatches(e){const t=e.filter((e=>e.teams.some((e=>this.config.esports.favoriteTeams.includes(e.toLowerCase())))));return this.todayFavoriteTeamsMatches=t,this.logger(`there were found ${this.todayFavoriteTeamsMatches.length} of your favorite teams in the next coulpe of days`),this.todayFavoriteTeamsMatches}generateEmailContent(e){let t="";const i="text-align: center;",n="border: 1px solid #333; white-space: nowrap; padding: 10px;",s=`<center>\n                    <table style="border: 1px solid #333; width: 90%">\n                      <colgroup>\n                        <col span="1" style="width: 20%;">\n                        <col span="1" style="width: 60%;">\n                        <col span="1" style="width: 20%;">\n                      </colgroup>\n                      <thead>${`<tr style="${i}">\n                      <th style="${n}">Time</th>\n                      <th style="${n}">Match</th>\n                      <th style="${n}">Game</th>\n                    </tr>`}</thead>\n                      <tbody>${(()=>e.map((e=>{const t=e.teamA.image||e.teamA.countryImage||"",s=e.teamB.image||e.teamB.countryImage||"";console.log(t);return`<tr style="${i}">\n                            <td style="${n}">\n                              <div style="text-align: center;">${this.config.settings.notifyOnlyAboutTodayGames?`<p style="white-space: nowrap;">${e.time}</p>`:`<p style="white-space: nowrap;">${e.date}</p><p style="white-space: nowrap;">${e.time}</p>`}</div>\n                            </td>\n                            <td style="${n}">\n                              <a href="${e.link}">\n                                <div style="display: flex; align-items: center; justify-content: center; gap: 150px;">\n                                  <div style="width: 100%;">\n                                    ${""===t?"":`<img src="${t}" width="20px" height="20px">`}\n                                    <p>${e.teamA.name}</p>\n                                  </div>\n                                  <div style="width: 100%;">\n                                    ${""===s?"":`<img src="${s}" width="20px" height="20px">`}\n                                    <p>${e.teamB.name}</p>\n                                  </div>\n                                </div>\n                                <p style="word-wrap: break-word;">${e.event}</p>\n                              </a>\n                            </td>\n                            <td style="${n}">\n                              <div style="text-align: center;">\n                                <a href="${e.game.link}">\n                                  <img width="50px" height="50px" src="${e.game.image}"><br>\n                                  <p>${e.game.name}</p>\n                                </a>\n                              </div>\n                            </td>\n                          </tr>`})).join(""))()}</tbody>\n                    </table>\n                  </center>`;return t+="Hi,<br><br>\n",t+=`there ${1===e.length?"is":"are"} <b>${e.length} ${1===e.length?"game":"games"}</b> of your favorite teams ${this.config.settings.notifyOnlyAboutTodayGames?"today":"soon"}: <br><br>\n`,t+=`${s}<br>\n`,t+=`Regards, <br>your <a href="https://github.com/${this.GITHUB_REPOSITORY}#readme"><b>${this.APPNAME}</b></a> bot`,t}sendEmail(e){0!==e.length&&(this.logger(`email sent to ${this.USER_EMAIL} to inform about ${e.length} games`),MailApp.sendEmail({to:this.USER_EMAIL,subject:`${this.APPNAME} - ${e.length} ${1===e.length?"game":"games"} of your favorite teams ${this.config.settings.notifyOnlyAboutTodayGames?`${this.TODAY_DATE}`:"soon"}`,htmlBody:this.generateEmailContent(e)}))}install(){this.logger(`install ${this.APPNAME}`);const e=this.config.datetime.timeToSendEmail.split(":");if(2!==e.length)throw new Error(this.ERRORS.timeToSendEmailIncorrect);const t=ScriptApp.getProjectTriggers().find((e=>e.getHandlerFunction()===this.config.settings.loopFunction));t&&(this.logger(`removed old trigger of function ${this.config.settings.loopFunction}`),ScriptApp.deleteTrigger(t)),this.logger(`the loop function ${this.config.settings.loopFunction} will be triggered everyday at ${this.config.datetime.timeToSendEmail}`),ScriptApp.newTrigger(this.config.settings.loopFunction).timeBased().everyDays(1).atHour(Number(e[0])).nearMinute(Number(e[1])).create()}uninstall(){this.logger(`uninstall ${this.APPNAME}`);const e=ScriptApp.getProjectTriggers().find((e=>e.getHandlerFunction()===this.config.settings.loopFunction));e&&ScriptApp.deleteTrigger(e)}checkTodayGames(){const e=this.getAllTodayMatches(),t=this.getFavoriteTeamsMatches(e),i=t.filter((e=>e.date===this.TODAY_DATE));this.logger(`there were found ${i.length} of your favorite teams today`,"after");const n=this.config.settings.notifyOnlyAboutTodayGames?i:t;this.sendEmail(n)}}